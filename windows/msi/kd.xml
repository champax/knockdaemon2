<?xml version="1.0"?>

<!-- VARS -->
<?define ProductVersion = "0.1.555.0"?>
<?define ProductUpgradeCode = "40a4641e-56fe-4272-831a-d2711ae73c61"?>

<!-- DO NOT REGEN GUID PLZ -->
<?define GUID1 = "40a4641e-56fe-4272-831a-d2711ae73c61"?>
<?define GUID2 = "ff96f0ba-9693-4492-ba12-51386f689cd5"?>
<?define GUID3 = "8842c2c2-13c2-417f-a639-5862a3e3edf8"?>

<!-- XML -->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

    <Product Id="*" UpgradeCode="$(var.ProductUpgradeCode)" Name="Knock Daemon" Version="$(var.ProductVersion)" Manufacturer="Knock SAS" Language="1033">
        <Package InstallerVersion="200" Compressed="yes" Comments="Knock Windows Installer Package">

        </Package>
        <Media Id="1" Cabinet="product.cab" EmbedCab="yes"/>
        <Icon Id="ProductIcon" SourceFile="..\pyinstaller\dist\k_logo.ico"/>
        <Property Id="ARPPRODUCTICON" Value="ProductIcon"/>
        <Property Id="ARPHELPLINK" Value="https://knock.center"/>
        <Property Id="ARPURLINFOABOUT" Value="https://knock.center"/>
        <!-- <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" /> -->
        <!-- <Property Id="ARPNOREMOVE" Value="yes" Secure="yes" /> -->
        <Property Id="ARPNOMODIFY" Value="yes" Secure="yes"/>
        <Property Id="WIXUI_EXITDIALOGOPTIONALTEXT" Value="Thank you for installing KnockDaemon."/>
        <Upgrade Id="$(var.ProductUpgradeCode)">
            <UpgradeVersion Minimum="$(var.ProductVersion)" OnlyDetect="yes" Property="NEWERVERSIONDETECTED"/>
            <UpgradeVersion Minimum="0.0.0" Maximum="$(var.ProductVersion)" IncludeMinimum="yes" IncludeMaximum="no" Property="OLDERVERSIONBEINGUPGRADED"/>
        </Upgrade>
        <Condition Message="A newer version of this software is already installed.">NOT NEWERVERSIONDETECTED</Condition>

        <!-- PUSH TO TARGETDIR, ProgramFilesFolder, Knock, KnockDaemon -->
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="ProgramFilesFolder">
                <Directory Id="INSTALLDIR" Name="Knock">
                    <Directory Id="KNOCKDIR" Name="KnockDaemon">
                        <!-- ROOT DIR -->
                        <Component Id="KnockDaemonFiles" Guid="$(var.GUID1)">
                            <!-- SERVICE FILE -->
                            <File Id="KD_exe" Source="..\pyinstaller\dist\KnockDaemon.exe"/>

                            <!-- SERVICE GO -->
                            <ServiceInstall
                                    Id="ServiceInstaller"
                                    Type="ownProcess"
                                    Name="KnockDaemon"
                                    DisplayName="KnockDaemon"
                                    Description="Monitoring and management Jobs"
                                    Start="auto"
                                    Account="[SERVICEACCOUNT]"
                                    Password="[SERVICEPASSWORD]"
                                    ErrorControl="normal"
                            >
                                <ServiceConfig
                                        DelayedAutoStart="yes"
                                        OnInstall="yes"
                                        OnReinstall="yes"/>
                                <util:ServiceConfig
                                        FirstFailureActionType='restart'
                                        SecondFailureActionType='restart'
                                        ThirdFailureActionType='restart'
                                        RestartServiceDelayInSeconds='120'
                                        ResetPeriodInDays='1'/>
                            </ServiceInstall>
                            <ServiceControl Id="StartService" Start="install" Stop="both" Remove="both" Name="KnockDaemon" Wait="yes">
                            </ServiceControl>

                            <!-- OTHER FILES -->
                            <File Id="KD_ico" Source="..\pyinstaller\dist\k_logo.ico"/>
                            <File Id="KD_png" Source="..\pyinstaller\dist\k_logo.png"/>
                            <File Id="KD_pyd" Source="..\pyinstaller\dist\win32evtlog.pyd"/>
                            <File Id="KD_checkdns" Source="..\pyinstaller\dist\k.CheckDns.json"/>
                            <File Id="KD_checkprocess" Source="..\pyinstaller\dist\k.CheckProcess.json"/>
                            <File Id="KD_ini" Source="..\pyinstaller\dist\knockdaemon.ini"/>
                        </Component>
                        <!-- CONF.D -->
                        <Directory Id="KNOCKDIR_CONFD" Name="conf.d">
                            <Component Id="KnockDaemonCustomConfigurationFiles" Guid="$(var.GUID2)">
                                <!-- SAMPLE FILE -->
                                <File Id="KD_confd_10authinisample" Source="..\pyinstaller\dist\conf.d\10_auth.ini.sample"/>

                                <!-- INIT UPDATE -->
                                <IniFile Id="KD_10_auth_custom_ini_1" Name="10_auth.ini" Action="addLine" Directory="KNOCKDIR_CONFD" Key="acc_namespace" Section="knockd" Value="[K_NAMESPACE]"/>
                                <IniFile Id="KD_10_auth_custom_ini_2" Name="10_auth.ini" Action="addLine" Directory="KNOCKDIR_CONFD" Key="acc_key" Section="knockd" Value="[K_API_KEY]"/>
                            </Component>
                        </Directory>
                    </Directory>
                </Directory>
            </Directory>

            <Directory Id="ProgramMenuFolder">
                <Directory Id="ProgramMenuSubfolder" Name="Knock">
                    <Component Id="KnockDaemonShortcuts" Guid="$(var.GUID3)">
                        <Shortcut Id="KDS_1" Name="Knock Daemon shortcut" Description="Knock Daemon" Target="[KNOCKDIR]KnockDaemon.exe" WorkingDirectory="KNOCKDIR"/>
                        <RegistryValue Root="HKCU" Key="Software\Knock\KnockDaemon" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
                        <RemoveFolder Id="ProgramMenuSubfolder" On="uninstall"/>
                    </Component>
                </Directory>
            </Directory>
        </Directory>

        <InstallExecuteSequence>
            <RemoveExistingProducts After="InstallValidate"/>
        </InstallExecuteSequence>

        <Feature Id="DefaultFeature" Level="1">
            <ComponentRef Id="KnockDaemonFiles"/>
            <ComponentRef Id="KnockDaemonCustomConfigurationFiles"/>
            <ComponentRef Id="KnockDaemonShortcuts"/>
        </Feature>

        <UI Id="KUI">
            <!-- =========================== -->
            <!-- CUSTOM DIALOG -->
            <!-- =========================== -->
            <Dialog Id="UserRegDialog" Width="370" Height="270" Title="Knock Daemon Setup">
                <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="!(loc.LicenseAgreementDlgBannerBitmap)"/>
                <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0"/>
                <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0"/>

                <Control Id="Title" Type="Text" X="15" Y="15" Width="300" Height="15" Transparent="yes" NoPrefix="yes" Text="{\WixUI_Font_Title}Knock namespace and api key"/>

                <Control Id="k_txt_1" X="25" Y="70" NoWrap="no" RightAligned="no" Transparent="yes" Type="Text" Width="320" Height="100" Text="Knock Daemon requires your namespace and api key to publish datas."/>
                <Control Id="k_txt_2" X="25" Y="90" NoWrap="no" RightAligned="no" Transparent="yes" Type="Text" Width="320" Height="100" Text="You can edit them later inside '\conf.d\10_auth.ini'."/>
                <Control Id="k_txt_3" X="25" Y="110" NoWrap="no" RightAligned="no" Transparent="yes" Type="Text" Width="320" Height="100" Text="Think to recycle Knock Daemon service whenever you modify this file."/>

                <Control Id="k_lab_namespace" Type="Text" X="25" Y="140" Height="17" Width="65" Transparent="yes" Text="Knock namespace"/>
                <Control Id="k_txt_namespace" Type="Edit" X="25" Y="150" Height="17" Width="120" Property="K_NAMESPACE" Text="Your_Namespace"/>

                <Control Id="k_lab_apikey" Type="Text" X="25" Y="180" Height="17" Width="65" Transparent="yes" Text="Knock api key"/>
                <Control Id="k_txt_apikey" Type="Edit" X="25" Y="190" Height="17" Width="120" Property="K_API_KEY" Text="Your_Api_Key"/>

                <!-- MSI to not react to input change, but only using tab key, so next button is not always refreshed (bullshit) -->
                <!-- SO WE DO NOT ENABLE Next / Off via code below -->
                <!--<Condition Action="disable"><![CDATA[K_NAMESPACE = "" OR K_API_KEY = ""]]></Condition>-->
                <!--<Condition Action="enable"><![CDATA[K_NAMESPACE <> "" AND K_API_KEY <> ""]]></Condition>-->

                <Control Id="Next" Type="PushButton" Text="Next" X="236" Y="243" Width="56" Height="17" Default="yes">
                    <Publish Event="EndDialog" Value="Return">1</Publish>

                </Control>

                <Control Id="Back" Type="PushButton" Text="Back" Cancel="yes" X="180" Y="243" Width="56" Height="17">
                    <Publish Event="EndDialog" Value="Exit"/>
                </Control>

                <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="!(loc.WixUICancel)">
                    <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
                </Control>

            </Dialog>

            <!-- =========================== -->
            <!-- COMMON -->
            <!-- =========================== -->
            <TextStyle Id="WixUI_Font_Normal" FaceName="Tahoma" Size="8"/>
            <TextStyle Id="WixUI_Font_Bigger" FaceName="Tahoma" Size="12"/>
            <TextStyle Id="WixUI_Font_Title" FaceName="Tahoma" Size="9" Bold="yes"/>

            <Property Id="DefaultUIFont" Value="WixUI_Font_Normal"/>
            <Property Id="WixUI_Mode" Value="Mondo"/>

            <DialogRef Id="ErrorDlg"/>
            <DialogRef Id="FatalError"/>
            <DialogRef Id="FilesInUse"/>
            <DialogRef Id="MsiRMFilesInUse"/>
            <DialogRef Id="PrepareDlg"/>
            <DialogRef Id="ProgressDlg"/>
            <DialogRef Id="ResumeDlg"/>
            <DialogRef Id="UserExit"/>
            <DialogRef Id="UserRegDialog"/>

            <!--    FLOW
                    Already installed   : WelcomeDlg => MaintenanceWelcomeDlg => MaintenanceTypeDlg => VerifyReadyDlg
                    Not installed       : WelcomeDlg => LicenseAgreementDlg => UserRegDialog => MaintenanceTypeDlg => VerifyReadyDlg
            -->

            <!-- WELCOME -->
            <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="UserRegDialog" Order="2">NOT Installed</Publish>
            <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="MaintenanceWelcomeDlg" Order="2">Installed</Publish>

            <!-- ALREADY INSTALLED / WELCOME -->
            <Publish Dialog="MaintenanceWelcomeDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg">1</Publish>
            <Publish Dialog="MaintenanceWelcomeDlg" Control="Next" Event="NewDialog" Value="MaintenanceTypeDlg">1</Publish>

            <!-- ALREADY INSTALLED / DETAILS -->
            <Publish Dialog="MaintenanceTypeDlg" Control="Back" Event="NewDialog" Value="MaintenanceWelcomeDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="RepairButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>

            <!-- CUSTOM INPUT -->
            <Publish Dialog="UserRegDialog" Control="Back" Event="NewDialog" Value="WelcomeDlg" Order="1">NOT Installed</Publish>
            <Publish Dialog="UserRegDialog" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg" Order="1">Installed</Publish>
            <Publish Dialog="UserRegDialog" Control="Next" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>

            <!-- VERIFY -->
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="UserRegDialog" Order="1">NOT Installed</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg" Order="1">Installed</Publish>

            <!-- EXIT -->
            <Publish Dialog="ExitDialog" Control="Finish" Event="EndDialog" Value="Return" Order="999">1</Publish>
        </UI>
        <UIRef Id="WixUI_Common"/>

    </Product>

</Wix>